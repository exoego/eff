<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>eff - エフェクトの作成</title>
    <link href="./images/s2.ico"                                   type="image/x-icon" rel="specs2 icon"/>
    <link href="./css/opensans-fonts.css"                          type="text/css"     rel="stylesheet" />
    <link href="./css/bootstrap.min.css"                           type="text/css"     rel="stylesheet" />
    <link href="./css/font-awesome.min.css"                        type="text/css"     rel="stylesheet" />
    <link href="./css/prettify.css"                                type="text/css"     rel="stylesheet" />
    <link href="./css/tabber.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/specs2.css"                                  type="text/css"     rel="stylesheet" />
    <!--<link href="./css/specs2-user.css"                             type="text/css"     rel="stylesheet" />-->

    <script src="./javascript/jquery.js"                           type="text/javascript"></script>
    <script src="./javascript/jquery.jstree.js"                    type="text/javascript"></script>
    <script src="./javascript/tabber.js"                           type="text/javascript"></script>
    <script src="./javascript/tabber_start.js"                     type="text/javascript"></script>
    <script src="./javascript/prettify.js"                         type="text/javascript"></script>
    <script src="./javascript/specs2.js"                           type="text/javascript"></script>
    <!--<script src="./javascript/specs2-user.js"                      type="text/javascript"></script>-->

</head>
<body onload="prettyPrint(); tabberAutomatic([])">

<div class="container">

<div class="col-md-10 col-sm-9 col-xs-9 col-md-push-2 ol-sm-push-3 col-xs-push-3">
        <h1>エフェクトの作成</h1>
        <div id="tipue_search_content"></div>

        <h3 id="creation">作成</h3>
        <p>新しいエフェクトはとても簡単にこのライブラリに追加できる。Effect 型を新しい「オプショナル型」用に作ってみよう。</p>
        <p>必要なものは、</p>
        <ul>
            <li><p>ベースとなる型。<code class="prettyprint">Maybe</code> データ型とする。２つのケース <code class="prettyprint">Just</code> と <code class="prettyprint">Nothing</code> がある。</p></li>
            <li><p><code class="prettyprint">A</code> 型の値を <code class="prettyprint">Eff[R, A]</code> に送り込むメソッド。</p></li>
            <li><p>インタープリター</p></li>
        </ul>
        <pre><code class="prettyprint">import cats._, implicits._
import org.atnos.eff._
import all._
import org.atnos.eff.interpret._

sealed trait Maybe[A]
case class Just[A](a: A) extends Maybe[A]
case class Nothing[A]() extends Maybe[A]

object MaybeEffect {
  type _maybe[R] = Maybe |= R

  def just[R :_maybe, A](a: A): Eff[R, A] =
    send[Maybe, R, A](Just(a))

  def nothing[R :_maybe, A]: Eff[R, A] =
    send[Maybe, R, A](Nothing())

  def runMaybe[R, U, A, B](effect: Eff[R, A])(implicit m: Member.Aux[Maybe, R, U]): Eff[U, Option[A]] =
    recurse(effect)(new Recurser[Maybe, U, A, Option[A]] {
      def onPure(a: A) = Some(a)

      def onEffect[X](m: Maybe[X]): X Either Eff[U, Option[A]] =
        m match {
          case Just(x)   =&gt; Left(x)
          case Nothing() =&gt; Right(Eff.pure(None))
        }

      def onApplicative[X, T[_]: Traverse](ms: T[Maybe[X]]): T[X] Either Maybe[T[X]] =
        Right(ms.sequence)
    })

  implicit val applicativeMaybe: Applicative[Maybe] = new Applicative[Maybe] {
    def pure[A](a: A): Maybe[A] = Just(a)

    def ap[A, B](ff: Maybe[A =&gt; B])(fa: Maybe[A]): Maybe[B] =
      (fa, ff) match {
        case (Just(a), Just(f)) =&gt; Just(f(a))
        case _                  =&gt; Nothing()
      }
  }
}
</code></pre>
        <p>上のコードでは、</p>
        <ul>
            <li><p><code class="prettyprint">just</code> と <code class="prettyprint">nothing</code> メソッドは、値を大きなエフェクト <code class="prettyprint">Eff[R, A]</code> に送り込むために、 <code class="prettyprint">Eff.send</code> を使っている。</p></li>
            <li><p><code class="prettyprint">runMaybe</code> は、<code class="prettyprint">Maybe</code> 値を <code class="prettyprint">Option</code> 値に翻訳するために <code class="prettyprint">interpret.recurse</code> と <code class="prettyprint">Recurser</code> を使うことで <code class="prettyprint">Maybe</code> エフェクトを実行している。</p></li>
        </ul>
        <h3 id="compiler-limitation">コンパイラーの制限</h3>
        <p>エフェクトを作るときは、そのエフェクトで起こり得ることの区別を表現するために sealed trait と case class を定義できる。たとえばデータベースとやりとりするときはこんな風に作るだろう。</p>
        <pre><code class="prettyprint">trait DatabaseEffect {

  case class Record(fields: List[String])

  sealed trait Db[A]
  case class Get[A](id: Int) extends Db[Record]
  case class Update[A](id: Int, record: Record) extends Db[Record]
}</code></pre>
        <p>実際は <code class="prettyprint">Db</code> 型を <code class="prettyprint">DatabaseEffect</code> trait の<strong>外側</strong>で作ることをおすすめする。<code class="prettyprint">Member</code> implicit が解決されるときに、<code class="prettyprint">Db</code> エフェクト型をどのようにインポートしているか（オブジェクトから継承しているか否か）によって、コンパイラーのクラッシュを経験するかもしれない :-(。</p>
        <h3 id="interpreter">インタープリター</h3>
        <p>通常、与えられたエフェクトを解釈（interpret）するということは、型 <code class="prettyprint">M[X]</code> の値に対してすべきことが分かっているということを意味する。 ここで <code class="prettyprint">M</code> はエフェクトだ。もしインタープリターがエフェクトを「実行（execute）」できるのなら、つまりログを出力したり（<code class="prettyprint">Writer</code>）、非同期に計算したり（<code class="prettyprint">Future</code>）、値をチェックしたり（<code class="prettyprint">Either</code>）できるなら、<code class="prettyprint">X</code> を取り出して、そして次のエフェクトを取得して同じ用に解釈できるように継続（continuation ）を呼び出すことができる。</p>
        <p><code class="prettyprint">org.atnos.eff.interpret</code> オブジェクトはインタープリターを書くためのいくつかの trait と関数を提供している。この例では <code class="prettyprint">Recurser</code> を使う。これは、<code class="prettyprint">Maybe[X]</code> から値 <code class="prettyprint">X</code> を 「取り出す」、もしくは諦めて <code class="prettyprint">Eff.pure(None)</code> を実行する。</p>
        <p><code class="prettyprint">runMaybe</code> メソッドは <code class="prettyprint">Member.Aux[Maybe, R, U]</code> 型の implicit パラメーターを必要とする。この型は次のように解釈すべきだ。</p>
        <ul>
            <li><code class="prettyprint">Maybe</code> はエフェクトスタック <code class="prettyprint">R</code> のメンバーでなければならず、<code class="prettyprint">R</code> から取り除くにはエフェクトスタック <code class="prettyprint">U</code> となるべきだ。</li>
        </ul>
        <p><br/></p>
        <p>これでこのエフェクトを計算で使える。</p>
        <pre><code class="prettyprint">import org.atnos.eff._
import org.atnos.eff.eff._
import MaybeEffect._

val action: Eff[Fx.fx1[Maybe], Int] =
  for {
    a &lt;- just(2)
    b &lt;- just(3)
  } yield a + b

run(runMaybe(action))</code></pre>
        <p><code class="prettyprint">&gt; Some(5)</code></p>
        <hr />
    </div>

<div class="col-md-2 col-sm-3 col-xs-3 col-md-pull-10 ol-sm-pull-9 col-xs-pull-9 sidebar-outer">
<div class="col-md-2 fixed">

<!-- search box -->
<div class="search-box">
</div>

<!-- table of contents -->
<div id="tree"><ul>
                <li id="index"><a href="index.html" title="eff">eff</a>
      <ul><ul><li><a href="index.html#contributing" title="貢献">貢献</a>
          
        </li></ul></ul>
      <ul>
                    <ul>
                <li id="org-atnos-site-installation"><a href="org.atnos.site.Installation.html" title="インストール">インストール</a>
      <ul><ul><li><a href="org.atnos.site.Installation.html#additional-dependencies" title="さらなる依存関係">さらなる依存関係</a>
          
        </li><li><a href="org.atnos.site.Installation.html#imports" title="インポート">インポート</a>
          <ul><li><a href="org.atnos.site.Installation.html#main-types" title="主要な型">主要な型</a>s</a>
          
        </li><li><a href="org.atnos.site.Installation.html#creating-effects" title="エフェクトの作成">エフェクトの作成</a>
          
        </li><li><a href="org.atnos.site.Installation.html#interpreting-effects"title="エフェクトの解釈">エフェクトの解釈</a>
          
        <!--</li><li><a href="org.atnos.site.Installation.html#intellij-support" title="Intellij support">Intellij support</a>-->
          
        </li><li><a href="org.atnos.site.Installation.html#with-scalaz" title="Scalaz と使う">Scalaz と使う</a>
          
        </li></ul>
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-introduction"><a href="org.atnos.site.Introduction.html" title="初めてのエフェクト">初めてのエフェクト</a>
      <ul><ul><li><a href="org.atnos.site.Introduction.html#first-example" title="最初の例">最初の例</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-outofthebox"><a href="org.atnos.site.OutOfTheBox.html" title="すぐ使えるエフェクト">すぐ使えるエフェクト</a>
      <ul><ul><li><a href="org.atnos.site.OutOfTheBox.html#what’s-next?" title="次にすることは？">次にすることは？</a>
          
        </li></ul></ul>
      <ul>
                    <ul>
                <li id="org-atnos-site-lib-evaleffectpage"><a href="org.atnos.site.lib.EvalEffectPage.html" title="Eval">Eval</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-optioneffectpage"><a href="org.atnos.site.lib.OptionEffectPage.html" title="Option">Option</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-eithereffectpage"><a href="org.atnos.site.lib.EitherEffectPage.html" title="Either">Either</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-validateeffectpage"><a href="org.atnos.site.lib.ValidateEffectPage.html" title="Validate">Validate</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-erroreffectpage"><a href="org.atnos.site.lib.ErrorEffectPage.html" title="Error">Error</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-readereffectpage"><a href="org.atnos.site.lib.ReaderEffectPage.html" title="Reader">Reader</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-writereffectpage"><a href="org.atnos.site.lib.WriterEffectPage.html" title="Writer">Writer</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-stateeffectpage"><a href="org.atnos.site.lib.StateEffectPage.html" title="State">State</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-listeffectpage"><a href="org.atnos.site.lib.ListEffectPage.html" title="List">List</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-chooseeffectpage"><a href="org.atnos.site.lib.ChooseEffectPage.html" title="Choose">Choose</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-memoeffectpage"><a href="org.atnos.site.lib.MemoEffectPage.html" title="Memo">Memo</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-timedfutureeffectpage"><a href="org.atnos.site.lib.TimedFutureEffectPage.html" title="TimedFuture">TimedFuture</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-taskeffectpage"><a href="org.atnos.site.lib.TaskEffectPage.html" title="Task">Task</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-lib-safeeffectpage"><a href="org.atnos.site.lib.SafeEffectPage.html" title="Safe">Safe</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul>
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-tutorial"><a href="org.atnos.site.Tutorial.html" title="Tutorial">Tutorial</a>
      <ul><ul><li><a href="org.atnos.site.Tutorial.html#study-your-topic" title="Study your topic">Study your topic</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#create-an-adt-representing-your-grammar" title="Create an ADT representing your grammar">Create an ADT r...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#free-your-adt" title="Free your ADT">Free your ADT</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#create-smart-constructors-using-eff.send" title="Create smart constructors using Eff.send">Create smart co...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#build-a-program" title="Build a program">Build a program</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#write-an-interpreter-for-your-program" title="Write an interpreter for your program">Write an interp...</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#run-your-program" title="Run your program">Run your program</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#add-some-syntax" title="Add some syntax">Add some syntax</a>
          
        </li><li><a href="org.atnos.site.Tutorial.html#composing-adts-with-the-eff-monad" title="Composing ADTs with the Eff monad">Composing ADTs ...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-createeffects"><a href="org.atnos.site.CreateEffects.html" title="エフェクトの作成">エフェクトの作成</a>
      <ul><ul><li><a href="org.atnos.site.CreateEffects.html#creation" title="作成">作成</a>
          
        </li><li><a href="org.atnos.site.CreateEffects.html#compiler-limitation" title="コンパイラーの制限">コンパイラーの制限</a>
          
        </li><li><a href="org.atnos.site.CreateEffects.html#interpreter" title="インタープリター">インタープリター</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-transformstack"><a href="org.atnos.site.TransformStack.html" title="Transform stacks">Transform stacks</a>
      <ul><ul><li><a href="org.atnos.site.TransformStack.html#what-is-an-“effect-stack”?" title="What is an “effect stack”?">What is an “eff...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#transform-an-effect-to-another" title="Transform an effect to another">Transform an ef...</a>
          <ul><li><a href="org.atnos.site.TransformStack.html#change-the-effect" title="Change the effect">Change the effect</a>
          
        </li></ul>
        </li><li><a href="org.atnos.site.TransformStack.html#translate-an-effect-into-multiple-others" title="Translate an effect into multiple others">Translate an ef...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#interpret-an-effect-“locally”" title="Interpret an effect “locally”">Interpret an ef...</a>
          
        </li><li><a href="org.atnos.site.TransformStack.html#merge-stacks" title="Merge stacks">Merge stacks</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-memberimplicits"><a href="org.atnos.site.MemberImplicits.html" title="Member implicits">Member implicits</a>
      <ul><ul><li><a href="org.atnos.site.MemberImplicits.html#running-effects-with-several-type-parameters" title="Running effects with several type parameters">Running effects...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#use-context-bounds-and-type-aliases" title="Use context bounds and type aliases">Use context bou...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#know-your-member-typeclasses" title="Know your Member typeclasses">Know your Membe...</a>
          
        </li><li><a href="org.atnos.site.MemberImplicits.html#“packing”-member-instances" title="“Packing” member instances">“Packing” membe...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-applicativeevaluation"><a href="org.atnos.site.ApplicativeEvaluation.html" title="Applicative">Applicative</a>
      <ul><ul><li><a href="org.atnos.site.ApplicativeEvaluation.html#concurrent-evaluation" title="Concurrent evaluation">Concurrent eval...</a>
          
        </li><li><a href="org.atnos.site.ApplicativeEvaluation.html#batching" title="Batching">Batching</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-cookbook"><a href="org.atnos.site.Cookbook.html" title="Cookbook">Cookbook</a>
      <ul><ul><li><a href="org.atnos.site.Cookbook.html#partial-interpretation" title="Partial Interpretation">Partial Interpr...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-atnos-site-communityresources"><a href="org.atnos.site.CommunityResources.html" title="Community resources">Community resou...</a>
      <ul><ul><li><a href="org.atnos.site.CommunityResources.html#blog-posts" title="Blog posts">Blog posts</a>
          
        </li><li><a href="org.atnos.site.CommunityResources.html#tutorials-&amp;-examples" title="Tutorials &amp; Examples">Tutorials &amp; Exa...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul>
                  </ul>
    </li>
              </ul></div><script>$(function () { $('#tree').jstree({'core':{'initially_open':['index','org-atnos-site-createeffects'], 'animation':200}, 'themes' : {'theme': 'default','url': './css/themes/default/style.css'}, 'plugins':['themes', 'html_data']}); });</script>

</div>
</div>


</div>

</body>
</html>
